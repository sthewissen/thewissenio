---
layout: post
title: Packaging your legacy dlls with NuGet
wordpress_id: 379
wordpress_url: http://www.dvolve.org/?p=379
date: '2016-08-08 21:25:12 +0200'
date_gmt: '2016-08-08 19:25:12 +0200'
categories:
- Code
tags:
- nuget
- ".net"
---
<p>When developing applications you inevitably encounter a piece of&nbsp;legacy code. In our case this code was put into DLL files that were being used by quite a lot projects. <!--more-->However, when you want to move towards automated builds using e.g. Visual Studio Team Services (which we will be using in this example) it will not have access to wherever you have these DLLs stored. The build is being made in the cloud after all. So how do you go about packaging your legacy DLLs into NuGet packages and hosting them in your own corporate feed?</p>
<h3>Step 1: Gather those DLL files!</h3>
<p>First step along the way is gathering up all the different DLL files that you want to package together. It doesn't quite matter how many of them you put into one NuGet package&nbsp;but if you see a few of them being used together a lot then it would make sense to put them into the same package.</p>
<h3>Step 2: Create a NuSpec file to define your package</h3>
<p>When creating your package the info you see in the NuGet Package Manager comes from a so called NuSpec file. This is a simple XML file with a <code>.nuspec</code> extension. Below is a sample of how that looks. It has quite some recognisable fields such as a title, an author and a file icon. The file icon needs to be hosted somewhere on the web though and can't be referenced from within the <code>.nuspec</code> file. The id is a unique name for the package and the version allows you to publish different versions of the package to your feed.</p>
<p>The most important elements are the <strong>references</strong> and&nbsp;<strong>files</strong> elements. The <strong>references</strong> element tells the NuGet Package Manager to create a project reference to the DLLs you link in its child elements. The&nbsp;files element lets you&nbsp;declare the set of files you want copied into your solution when the package is installed. For each file&nbsp;you need to specify the source (where the file should be found when creating the package) and the target (where the files should be copied when the package is installed). In this sample we installed some of <a href="http://rebex.net">Rebex</a>' components, which are currently not available as a NuGet package.</p>
<p><script src="https://gist.github.com/sthewissen/8e67c61e44bacc220dbd825d7d313506.js"></script></p>
<h3>Step 3: Building&nbsp;a package using the command-line</h3>
<p>Once you've completed your <code>.nuspec</code>&nbsp;file you can start building the package. This is done through the NuGet.exe command line tool. &nbsp;You can get this from <a href="https://github.com/nuget">Github</a>. Using the pack command you can package everything into a nice <code>.nupkg</code>&nbsp;file. Running the following command from within the folder where your <code>.nuspec</code>&nbsp;file resides should give you your package.</p>
<p><code>"C:\Program Files (x86)\NuGet\NuGet.exe" pack Sample.nuspec -NoPackageAnalysis</code></p>
<h3>Step 4: Publishing to Visual Studio Team Services</h3>
<p>If you haven't created a NuGet feed yet in your VSTS installation, go ahead and do so now. It's as simple as going to the Package tab from within a Team Project and clicking New Feed. Fill in a name, a description and set some permissions, hit Create and presto! Your feed is&nbsp;created.</p>
<p><a href="/images/posts/create-new-feed.png"><img class="img-responsive aligncenter size-medium wp-image-398" src="/images/posts/create-new-feed-360x301.png" alt="create-new-feed" width="360" height="301" /></a></p>
<p>When that is done you can start connecting to it. Luckily there's a button to do just that within this same tab! Hit the connect button and set the tool&nbsp;to NuGet 3.3+. A shiny button will appear where you can download a NuGet.exe packaged with some credential providers that will let you connect to your VSTS instance.
 <a href="/images/posts/credential-provider.png"><img class="img-responsive aligncenter wp-image-394 size-medium" src="/images/posts/credential-provider-360x266.png" alt="credential-provider" width="360" height="266" /></a></p>
<p>After downloading the necessary stuff, extract the files and run the following command using the NuGet.exe from the download:</p>
<p><code>nuget.exe push -Source {NuGet package source URL} -ApiKey VSTS {your_package}.nupkg</code></p>
<p>The package source URL is found in the dialog where you downloaded your NuGet.exe earlier in this step. The package name should match the name of the package you just generated. A dialog prompting for your credentials to connect to VSTS should appear. Fill in the necessary fields and when the process is done your package should appear in the feed on Visual Studio Team Services.</p>
<h3>Step 5: Integrating your custom feed with&nbsp;the build</h3>
<p>The final step is integrating this new package in your builds. Ensure that you've added the new NuGet package to your project and check in your changes. Since you're hosting your newly created package on a NuGet feed of your own that the build process doesn't know about we need to tell our build process that it should look elsewhere for it. This is done by adding a <code>nuget.config</code>&nbsp;file to the Team Project (by adding it into a solution folder for example). The <code>nuget.config</code> looks like this:</p>
<p><script src="https://gist.github.com/sthewissen/3f3bf5ea681883404b357130840c3d38.js"></script></p>
<p>Once you've checked in the newly created config file you can edit your build definition. Add or edit your NuGet package restore step and point the <strong>Path to NuGet.config</strong>&nbsp;variable to the config file you've just checked in. Save your build definition and you should be good to go!</p>
<p><a href="/images/posts/build-definitions.png"><img class="img-responsive aligncenter size-medium wp-image-397" src="/images/posts/build-definitions-360x185.png" alt="build-definitions" width="360" height="185" /></a></p>
